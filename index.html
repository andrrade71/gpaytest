<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Pay (TEST) ‚Äî POC Cielo</title>
    <script async src="https://pay.google.com/gp/p/js/pay.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f9fafb;
        color: #222;
        margin: 0;
        padding: 20px;
      }

      h1 {
        text-align: center;
        color: #202124;
      }

      #payButton {
        display: block;
        margin: 30px auto;
        background: #000;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 18px;
        padding: 15px 30px;
        cursor: pointer;
        transition: background 0.3s;
      }
      #payButton:hover {
        background: #333;
      }

      #logContainer {
        margin-top: 20px;
        padding: 15px;
        border: 1px solid #ccc;
        background: #fff;
        height: 250px;
        overflow-y: auto;
        font-family: monospace;
        white-space: pre-wrap;
      }

      #logContainer p {
        margin: 0;
        padding: 2px 0;
      }
    </style>
  </head>
  <body>
    <h1>Google Pay (TEST)</h1>
    <button id="payButton">üí≥ Pagar com Google Pay</button>

    <div id="logContainer"></div>

    <script>
      const params = new URLSearchParams(location.search);
      const BACKEND =
        params.get("backend") || "https://gpaytest-back.onrender.com";
      const GWMID =
        params.get("gatewayMerchantId") ||
        "bf8c9702-6aea-4ed1-b856-3b17761263c0";
      const RETURN_URL = params.get("return") || "myapp://gpay/retorno";

      const log = (msg, data = null) => {
        const container = document.getElementById("logContainer");
        const entry = document.createElement("p");
        const now = new Date().toLocaleTimeString();
        entry.textContent = `[${now}] ${msg}`;
        if (data) entry.textContent += " " + JSON.stringify(data, null, 2);
        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;
        console.log(msg, data);
      };

      // ---------- CONFIG DO GOOGLE PAY ----------
      const baseRequest = {
        apiVersion: 2,
        apiVersionMinor: 0,
      };

      const allowedCardNetworks = ["VISA", "MASTERCARD"];
      const allowedCardAuthMethods = ["PAN_ONLY", "CRYPTOGRAM_3DS"];

      const tokenizationSpecification = {
        type: "PAYMENT_GATEWAY",
        parameters: {
          gateway: "cielo",
          gatewayMerchantId: GWMID,
        },
      };

      const baseCardPaymentMethod = {
        type: "CARD",
        parameters: {
          allowedAuthMethods: allowedCardAuthMethods,
          allowedCardNetworks: allowedCardNetworks,
        },
      };

      const cardPaymentMethod = Object.assign(
        { tokenizationSpecification: tokenizationSpecification },
        baseCardPaymentMethod
      );

      const paymentsClient = new google.payments.api.PaymentsClient({
        environment: "TEST",
      });

      async function onGooglePayLoaded() {
        const isReadyToPayRequest = Object.assign({}, baseRequest);
        isReadyToPayRequest.allowedPaymentMethods = [baseCardPaymentMethod];
        try {
          const response = await paymentsClient.isReadyToPay(
            isReadyToPayRequest
          );
          if (response.result) {
            log("‚úÖ Google Pay dispon√≠vel neste dispositivo.");
          } else {
            log("‚ö†Ô∏è Google Pay n√£o est√° dispon√≠vel.");
          }
        } catch (err) {
          log("‚ùå Erro no isReadyToPay:", err);
        }
      }

      onGooglePayLoaded();

      document
        .getElementById("payButton")
        .addEventListener("click", onBuyClicked);

      async function onBuyClicked() {
        log("üü¢ Iniciando fluxo de pagamento...");

        const paymentDataRequest = Object.assign({}, baseRequest);
        paymentDataRequest.allowedPaymentMethods = [cardPaymentMethod];
        paymentDataRequest.transactionInfo = {
          totalPriceStatus: "FINAL",
          totalPrice: "1.00",
          currencyCode: "BRL",
          countryCode: "BR",
        };
        paymentDataRequest.merchantInfo = {
          merchantName: "POC Cielo GPay",
        };

        try {
          const paymentData = await paymentsClient.loadPaymentData(
            paymentDataRequest
          );
          log("‚úÖ PaymentData recebido:", paymentData);

          // Envia para o backend
          const res = await fetch(`${BACKEND}/process-payment`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(paymentData),
          });

          const result = await res.json();
          log("üì¶ Resposta do backend:", result);

          window.location.href = RETURN_URL;
        } catch (err) {
          if (err.statusCode) {
            log(`‚ö†Ô∏è Usu√°rio cancelou (${err.statusCode})`);
          } else {
            log("‚ùå Erro ao processar pagamento:", err);
          }
        }
      }
    </script>
  </body>
</html>
