<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Pay (TEST) — POC DPAN / Débito</title>
    <script src="https://pay.google.com/gp/p/js/pay.js"></script>
    <style>
      body {
        font-family: "Roboto", sans-serif;
        background: #f5f5f5;
        margin: 0;
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      h1 {
        color: #202124;
        margin-bottom: 10px;
        text-align: center;
      }

      #payButton {
        background-color: #000;
        color: #fff;
        border: none;
        border-radius: 6px;
        padding: 16px 32px;
        font-size: 18px;
        cursor: pointer;
        margin-top: 20px;
        transition: opacity 0.2s;
      }

      #payButton:disabled {
        opacity: 0.5;
        cursor: not-allowed;
      }

      #logContainer {
        width: 90%;
        max-width: 600px;
        height: 300px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #ccc;
        border-radius: 6px;
        margin-top: 30px;
        padding: 10px;
        font-size: 14px;
        color: #333;
        white-space: pre-wrap;
      }

      .log-entry {
        margin-bottom: 5px;
        border-bottom: 1px solid #eee;
        padding-bottom: 4px;
      }

      .timestamp {
        color: #777;
        font-size: 12px;
        margin-right: 8px;
      }

      .success {
        color: green;
      }
      .error {
        color: red;
      }
      .info {
        color: #007bff;
      }
    </style>
  </head>
  <body>
    <h1>Google Pay (TEST) — POC DPAN / Débito</h1>
    <button id="payButton" disabled>💳 Pagar com Google Pay</button>

    <div id="logContainer"></div>

    <script>
      // Lê parâmetros via query string
      const params = new URLSearchParams(location.search);
      const BACKEND = params.get("backend") || "https://SEU_BACKEND.com";
      const GWMID =
        params.get("gatewayMerchantId") ||
        "XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX";
      const RETURN_URL = params.get("return") || "myapp://gpay/retorno";

      // Log visual + console
      function log(message, data = null, type = "info") {
        const container = document.getElementById("logContainer");
        const entry = document.createElement("div");
        entry.classList.add("log-entry", type);
        const now = new Date().toLocaleTimeString();
        entry.innerHTML = `<span class="timestamp">[${now}]</span> ${message}`;
        if (data) {
          entry.innerHTML += `<pre>${JSON.stringify(data, null, 2)}</pre>`;
        }
        container.appendChild(entry);
        container.scrollTop = container.scrollHeight;
        console.log(message, data || "");
      }

      // --- ADICIONE ESTA LINHA ---
      log("🔵 Backend URL definida:", BACKEND, "info");
      // -------------------------

      // Log mais detalhado de parâmetros
      log("🔎 Parâmetros iniciais:", { BACKEND, GWMID, RETURN_URL }, "info");

      // Helpers de debug
      function maskToken(t) {
        try {
          if (!t) return "N/A";
          const len = t.length || 0;
          if (len <= 30) return t;
          return `${t.slice(0, 10)}…(${len})…${t.slice(-10)}`;
        } catch (e) {
          return "(mask-error)";
        }
      }

      const __timings = {};
      function mark(name) { __timings[name] = Date.now(); }
      function elapsed(startName) {
        if (!__timings[startName]) return null;
        return Date.now() - __timings[startName];
      }

      let paymentsClient = null;

      function initGooglePay() {
        log("🔄 Inicializando Google Pay...");
        try {
          paymentsClient = new google.payments.api.PaymentsClient({
            environment: "TEST",
          });
          checkReadyToPay();
        } catch (err) {
          log("❌ Erro ao inicializar o cliente GPay:", err, "error");
        }
      }

      async function checkReadyToPay() {
        const request = {
          apiVersion: 2,
          apiVersionMinor: 0,
          allowedPaymentMethods: [
            {
              type: "CARD",
              parameters: {
                allowedAuthMethods: ["PAN_ONLY", "CRYPTOGRAM_3DS"],
                allowedCardNetworks: ["VISA", "MASTERCARD"],
              },
            },
          ],
        };

        try {
          log("➡️ isReadyToPay request:", request, "info");
          mark('isReadyToPay');
          const res = await paymentsClient.isReadyToPay(request);
          log(`⏱ isReadyToPay elapsed: ${elapsed('isReadyToPay')}ms`, null, "info");
          if (res.result) {
            log("✅ Google Pay disponível no dispositivo.", null, "success");
            document.getElementById("payButton").disabled = false;
          } else {
            log(
              "⚠️ Google Pay não disponível neste dispositivo.",
              null,
              "error"
            );
          }
        } catch (err) {
          log("❌ Erro em isReadyToPay:", err, "error");
        }
      }

      async function onBuyClicked() {
        log("🟢 Iniciando fluxo de pagamento...");

        const paymentDataRequest = {
          apiVersion: 2,
          apiVersionMinor: 0,
          allowedPaymentMethods: [
            {
              type: "CARD",
              parameters: {
                allowedAuthMethods: ["PAN_ONLY", "CRYPTOGRAM_3DS"], // foco DPAN
                allowedCardNetworks: ["VISA", "MASTERCARD", "AMEX", "ELO"],
                billingAddressRequired: false,
              },
              tokenizationSpecification: {
                type: "PAYMENT_GATEWAY",
                parameters: {
                  gateway: "cielo",
                  gatewayMerchantId: GWMID,
                },
              },
            },
          ],
          transactionInfo: {
            totalPriceStatus: "FINAL",
            totalPrice: "1.00", // R$ 1,00. O backend deve usar 100 (centavos)
            currencyCode: "BRL",
            countryCode: "BR",
          },
          merchantInfo: {
            merchantName: "POC Cielo GPay",
          },
        };

        try {
          log("➡️ Chamando paymentsClient.loadPaymentData com:", paymentDataRequest, "info");
          mark('loadPaymentData');
          const paymentData = await paymentsClient.loadPaymentData(
            paymentDataRequest
          );
          log(`⏱ loadPaymentData elapsed: ${elapsed('loadPaymentData')}ms`, null, "info");
          const gpayToken =
            paymentData?.paymentMethodData?.tokenizationData?.token;
          log("✅ PaymentData recebido (token mascarado):", {
            paymentMethodData: paymentData?.paymentMethodData ? {
              description: paymentData.paymentMethodData.description,
              tokenPreview: maskToken(gpayToken)
            } : null
          }, "success");
          if (!gpayToken) throw new Error("NO_TOKEN");

          // Chamar o endpoint /gpay/debit com o payload esperado
          const res = await fetch(`${BACKEND}/gpay/debit`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              GooglePayToken: gpayToken,
              Amount: 100, // centavos
              OrderId: `GPay-POC-${Date.now()}`,
              CustomerName: "Cliente GPay Teste",
              SoftDescriptor: "POC-GPay",
            }),
          });

          mark('fetch');
          const result = await res.json();
          log(`⏱ fetch elapsed: ${elapsed('fetch')}ms`, { status: res.status, ok: res.ok }, "info");
          log("📦 Resposta do backend:", result, res.ok ? "success" : "error");

          if (!res.ok) {
            throw new Error(
              "Erro no backend: " +
                JSON.stringify(result.data || result.error || result)
            );
          }

          const paymentId =
            result?.Payment?.PaymentId || result?.PaymentId || "NA";
          const status =
            result?.Payment?.Status || (res.ok ? "approved" : "error");
          const finalUrl = `${RETURN_URL}?status=${encodeURIComponent(
            status
          )}&paymentId=${encodeURIComponent(paymentId)}`;

    log("Redirecionando para o App: " + finalUrl, null, "info");
          window.location.href = finalUrl;
        } catch (err) {
          if (err && err.statusCode) {
            log(`⚠️ Usuário cancelou (${err.statusCode})`, null, "error");
          } else {
            log(
              "❌ Erro ao processar pagamento:",
              {
                name: err?.name || "Error",
                message: err?.message || String(err),
                stack: err?.stack
                  ? err.stack.split("\n")[1] || err.stack
                  : "N/A",
              },
              "error"
            );
            const finalUrl = `${RETURN_URL}?status=ERROR&error=${encodeURIComponent(
              err?.message || String(err)
            )}`;
            window.location.href = finalUrl;
          }
        }
      }

      window.addEventListener("load", () => {
        document
          .getElementById("payButton")
          .addEventListener("click", onBuyClicked);
        initGooglePay();
      });
    </script>
  </body>
</html>
